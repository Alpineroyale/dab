version: '3.2'

services:

  dab:
    build:
      context: ../
      dockerfile: Dockerfile
      cache_from:
        - alpine:latest
        - nekroze/dab:latest
    image: nekroze/dab:latest

  test:
    build:
      context: .
      dockerfile: Dockerfile
      cache_from:
        - alpine:latest
        - nekroze/dab:tests
        - koalaman/shellcheck-alpine:stable
        - golang:alpine
        - ruby:2.5
    image: nekroze/dab:tests
    environment:
      DAB_REPO_PATH: /tmp/dab/repos
      DAB_CONF_PATH: /tmp/dab/config
      DAB_DEV_MOUNT: 'no'
      DAB_AUTOUPDATE: 'no'
      DAB_UID: '0'
      DAB_GID: '0'
    volumes:
      - /etc/group:/etc/group:ro
      - /var/run/docker.sock:/var/run/docker.sock
      - /tmp/dab/repos:/tmp/dab/repos
      - /tmp/dab/config:/tmp/dab/config
      - ../dab:/usr/src/app/dab:ro
